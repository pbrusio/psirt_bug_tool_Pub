# Work Log: December 15, 2025

## Session Summary: Frontend Bug Fixes & API Schema Alignment

This session focused on resolving critical frontend crashes in the Device Inventory module, specifically the "Compare Versions" feature and related modals. The work revealed systematic mismatches between the backend API response schemas and the frontend TypeScript interfaces.

---

## Issues Addressed

### Issue 1: AI Assistant Showing Wrong Bug Count (9,725)

**Symptom:** The Security Posture Summary in the AI Assistant tab showed "Total Vulnerabilities: 9,725" - which was the entire database count, not bugs affecting the user's inventory.

**Root Cause:**
- Backend `reasoning_engine.py` returned a key named `bugs_affecting_inventory`
- Frontend expected the key `total_advisories` (as defined in the API response type)

**Fix Location:** `backend/core/reasoning_engine.py` line ~1305-1335
```python
# Changed from:
return {
    'bugs_affecting_inventory': total_affecting_bugs,
    ...
}
# To:
return {
    'total_advisories': total_affecting_bugs,  # Matches API schema
    ...
}
```

**Also Updated:** `frontend/src/components/AIAssistant.tsx` line 126 - Changed label from "Total Vulnerabilities" to "Bugs Affecting Inventory"

---

### Issue 2: Compare Versions Feature Crashing (Blank Screen)

**Symptom:** Clicking "Compare Versions" in Device Inventory showed a blank white screen. React crashed silently.

**Root Cause Analysis:** Two-part problem:

#### Part A: Backend Response Schema Mismatch
The `/api/v1/inventory/compare-versions` endpoint returned different keys than the frontend expected:

| Backend Returned | Frontend Expected |
|-----------------|-------------------|
| `current_version` | `current_version_scan` |
| `target_version` | `target_version_scan` |
| `fixed_bugs` | `fixed_in_upgrade` |
| `new_bugs` | `new_in_upgrade` |
| `unchanged_bugs` | `still_present` |
| `recommendation` (string) | `upgrade_recommendation` (object with `risk_level`, `risk_score`, `recommendation`) |

**Fix Location:** `backend/api/inventory_routes.py` lines 888-912
- Updated all response keys to match frontend expectations
- Refactored `_generate_upgrade_recommendation()` to return a dict with `risk_level`, `risk_score`, and `recommendation` fields

#### Part B: Bug Interface Type Mismatch
The frontend `Bug` interface in `InventoryManager.tsx` didn't match the actual backend bug structure:

| Bug Interface Had | Backend Actually Returns |
|-------------------|-------------------------|
| `title: string` | `headline: string` |
| `severity: string` | `severity: number` (1=Critical, 2=High, etc.) |
| `fixed_versions: string[]` | `affected_versions: string` (not an array!) |
| `score: number` | (doesn't exist) |

**Fix Location:** `frontend/src/components/InventoryManager.tsx` lines 51-61
```typescript
// Updated Bug interface:
interface Bug {
  bug_id: string;
  headline: string;  // was 'title'
  summary: string;
  severity: number | string;  // was 'string' only
  affected_versions: string;  // was 'string[]' and was 'fixed_versions'
  status: string;
  labels: string[];
  url: string;
  hardware_model?: string | null;
}
```

---

### Issue 3: Scan Comparison Modal Using Wrong Field Names

**Symptom:** Even after fixing the Bug interface, the scan comparison modal (`showCompareModal`) still crashed because it referenced old field names.

**Root Cause:** The modal JSX code used:
- `vuln.title` instead of `bug.headline`
- `vuln.severity === 'Critical'` (string comparison) instead of numeric severity
- `vuln.fixed_versions.join(', ')` instead of `bug.affected_versions` (string)

**Fix Locations:** `frontend/src/components/InventoryManager.tsx` lines 1140-1240
- Changed all `vuln` variable names to `bug` in map callbacks
- Replaced inline severity string comparisons with helper functions:
  ```typescript
  const getSeverityColor = (severity: number | string) => {...}
  const getSeverityLabel = (severity: number | string) => {...}
  ```
- Changed `bug.headline` display instead of `bug.title`
- Changed `bug.affected_versions` (string) instead of `bug.fixed_versions.join()`

---

### Issue 4: View Details Modal Using Wrong Field Names

**Symptom:** TypeScript build errors on lines 966, 975, 979 - `Property 'title' does not exist on type 'Bug'`

**Root Cause:** Same as Issue 3 - the View Details modal (selectedScanResult display) used old field names.

**Fix Location:** `frontend/src/components/InventoryManager.tsx` lines 951-993
- Applied same fixes as scan comparison modal
- Used `getSeverityColor()` and `getSeverityLabel()` helper functions
- Changed `bug.headline` and `bug.affected_versions`

---

## Files Modified

### Backend
1. **`backend/core/reasoning_engine.py`**
   - Changed `bugs_affecting_inventory` → `total_advisories` in summary() return dict

2. **`backend/api/inventory_routes.py`**
   - Updated compare-versions endpoint response keys
   - Refactored `_generate_upgrade_recommendation()` function

### Frontend
1. **`frontend/src/components/InventoryManager.tsx`**
   - Updated `Bug` interface to match backend response
   - Added `getSeverityColor()` and `getSeverityLabel()` helper functions
   - Fixed scan comparison modal (new/fixed/unchanged tabs)
   - Fixed version comparison modal (new/fixed/unchanged tabs)
   - Fixed View Details modal

2. **`frontend/src/components/AIAssistant.tsx`**
   - Changed "Total Vulnerabilities" label to "Bugs Affecting Inventory"

---

## Testing & Verification

1. **Build Verification:**
   ```bash
   cd frontend && npm run build
   # Result: ✓ built in 624ms - No TypeScript errors
   ```

2. **Type Safety:** All `Bug` type usages now correctly reference:
   - `bug.headline` for title
   - `bug.severity` (numeric)
   - `bug.affected_versions` (string)
   - Helper functions for severity display

---

## Lessons Learned

1. **API Contract Enforcement:** Need stronger typing between backend and frontend. Consider:
   - Shared type definitions (OpenAPI schema generation)
   - Runtime validation with Pydantic/Zod
   - API contract tests

2. **Frontend Type Safety:** The local `Bug` interface diverged from the shared `types/index.ts` definition. Should have a single source of truth.

3. **Field Naming Conventions:** Backend uses `headline` (from Cisco Bug API), frontend team used `title`. Need consistent naming conventions documented.

4. **Severity Encoding:** Backend stores severity as numeric (1-4), but some parts of the system converted to strings. Standardize on numeric throughout.

---

## Time Spent

| Task | Duration |
|------|----------|
| Investigation & diagnosis | ~30 min |
| Backend API fixes | ~15 min |
| Frontend Bug interface fix | ~10 min |
| Modal field name fixes | ~25 min |
| Build verification | ~5 min |
| **Total** | **~85 min** |

---

## Follow-up Tasks

1. ~~Create comprehensive CHANGELOG_V3.md~~ (this session)
2. ~~Update all documentation~~ (this session)
3. Consider adding API contract tests
4. Consider generating TypeScript types from OpenAPI schema
5. Add integration tests for comparison features

---

# Session 2: Version 3.1 - UI Polish & Data Cleanup

## Issues Addressed

### Issue 5: Unknown PSIRT Platforms (106 of 108 PSIRTs)

**Symptom:** System Admin PSIRTs tab showed 106 of 108 PSIRTs with "Unknown" platform.

**Root Cause:** PSIRTs were imported without proper platform detection. Advisory IDs contained hints but were not parsed.

**Fix:** Database migration to assign platforms based on:
1. Advisory ID patterns (e.g., `cisco-sa-iosxe-*` → IOS-XE)
2. Product keywords (e.g., `cat9k`, `asr903`, `snort3`)
3. Deletion of unsupported products (DNA Center, Catalyst Center, UCS, vManage, ISE)

**Results:**
| Action | Count |
|--------|-------|
| Assigned to IOS-XE | 53 |
| Assigned to FTD | 20 |
| Assigned to IOS-XR | 6 |
| Assigned to NX-OS | 6 |
| Assigned to ASA | 3 |
| Deleted (unsupported) | 20 |

**Final:** 88 PSIRTs with proper platform assignments, 0 Unknown.

---

### Issue 6: AI Assistant Showing Database Totals Instead of Inventory Impact

**Symptom:** AI Assistant showed "9,617 Total Bugs" - the entire database, not bugs affecting scanned inventory.

**Root Cause:** Frontend `AIAssistant.tsx` displayed `bugs.total` (database count) instead of `total_advisories` (inventory-affecting bugs).

**Fix:** Restructured AI Assistant dashboard:
1. **Primary Metrics** - Bugs Affecting Inventory (from `total_advisories`)
2. **Database Totals (Reference)** - Secondary section with Bugs/PSIRTs toggle

---

### Issue 7: Platform Display Cut Off in AI Assistant

**Symptom:** Database Totals section only showed 2 platforms (ASA, FTD) due to `.slice(0, 2)`.

**Fix:**
- Removed `.slice(0, 2)` limit
- Updated grid: `grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-7`
- Now shows all 5 platforms + Total + Critical/High

---

### Issue 8: Legacy Test Failures

**Symptom:** Tests failed due to terminology mismatch (`vulnerabilities` vs `bugs`).

**Files Fixed:**
- `tests/architecture/test_baseline.py` - Changed `vulnerabilities` → `bugs`
- `tests/architecture/test_refactor.py` - Updated field expectations
- `tests/unit/test_version_matcher.py` - Rewrote to use `VersionParser` API

**Test Results:** 155 passed, 3 failed (unrelated), 21 skipped

---

## Files Modified (Session 2)

### Backend
- `backend/core/db_scanner.py` - Fixed sqlite3.Row `.get()` error

### Frontend
- `frontend/src/components/AIAssistant.tsx` - Dashboard restructure, JSX fix

### Database
- `vulnerability_db.sqlite` - PSIRT platform cleanup (88 records updated)

### Tests
- `tests/architecture/test_baseline.py`
- `tests/architecture/test_refactor.py`
- `tests/unit/test_version_matcher.py`

### Documentation
- `CLAUDE.md` - Version 3.1 release notes

---

## Time Spent (Session 2)

| Task | Duration |
|------|----------|
| PSIRT platform investigation & cleanup | ~20 min |
| AI Assistant dashboard restructure | ~15 min |
| JSX structure fix | ~5 min |
| Test fixes | ~15 min |
| Documentation updates | ~10 min |
| **Total** | **~65 min** |
