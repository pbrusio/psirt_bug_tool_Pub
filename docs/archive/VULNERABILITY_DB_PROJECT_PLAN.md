# Vulnerability Database Project Plan

**Branch**: `feature/vulnerability-database` (merged to main)
**Status**: âœ… IMPLEMENTED
**Goal**: Shift from single-PSIRT analysis to comprehensive vulnerability scanning with local SQLite database

> **Note:** This planning document has been fully implemented. The vulnerability database is now in production
> with 9,586 bugs across 4 platforms. See `backend/db/README_VULN_DB.md` for current schema documentation.

## Project Overview

### Current State (Preserved on main/feature/snapshot-verification)
- âœ… Single PSIRT analysis with SEC-8B few-shot learning
- âœ… Live SSH device verification
- âœ… Air-gapped snapshot verification
- âœ… React UI with dark mode
- âœ… 2,654 labeled training examples (PSIRTs + bugs)

### New Architecture (This Branch)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Device/Snapshot Input                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dual-Path Router                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Path A: Database Scan (known vulns)   â”‚
â”‚  - Query SQLite (~10ms)                 â”‚
â”‚  - Match version + labels               â”‚
â”‚  - Return all matching bugs + PSIRTs    â”‚
â”‚                                         â”‚
â”‚  Path B: LLM Analysis (unknown vulns)  â”‚
â”‚  - SEC-8B few-shot (existing)          â”‚
â”‚  - Cache result in DB                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Phase 1: Database Layer (IOS-XE Only)

### 1.1 Database Schema & Core Logic
**Owner**: VulnerabilityDBArchitectAgent
**Files**:
- `backend/db/vuln_schema.sql` - SQLite schema
- `backend/core/version_matcher.py` - Version pattern matching
- `backend/core/version_patterns.py` - Pattern detection

**Schema Requirements**:
```sql
-- Main table: 1 row per vulnerability
vulnerabilities (
  advisory_id UNIQUE,
  type (PSIRT/BUG),
  platform,
  summary,
  severity (1-6),
  labels JSON,
  affected_versions_raw TEXT,
  fixed_versions_raw TEXT,
  version_pattern ('EXPLICIT', 'WILDCARD', 'OPEN_LATER', 'OPEN_EARLIER'),
  ...
)

-- Version index for fast scanning
version_index (vuln_id, platform, major, minor, patch, is_wildcard, is_open_ended)

-- Label index for feature matching
label_index (vuln_id, platform, label)

-- Metadata for incremental updates
db_metadata (key, value, updated_at)
```

**Version Pattern Logic**:
- `17.10.1 17.10.5` â†’ EXPLICIT (only those versions)
- `17.10.x` â†’ WILDCARD (all 17.10.*)
- `17.10.3 and later` â†’ OPEN_LATER (17.10.3+, not 17.11.x)
- `17.10.4 and earlier` â†’ OPEN_EARLIER (17.10.0 - 17.10.4)
- `17.x` â†’ MAJOR_WILDCARD (all 17.*.*)
- First Fixed Release: Critical for determining safe versions

**Deliverables**:
- [ ] SQL schema with indexes
- [ ] VersionPatternDetector class
- [ ] VersionMatcher class with pattern matching logic
- [ ] Unit tests for version matching edge cases

---

### 1.2 Bug CSV Loader
**Owner**: VulnerabilityDBArchitectAgent
**Files**:
- `backend/db/load_bugs.py` - Main loader script
- `backend/db/check_labels.py` - Validate labels exist

**Input**: `bugs/Cat9Kbugs_IOSXE_17.csv`
**Columns**:
- `BUG Id` â†’ advisory_id
- `Bug Severity` â†’ severity (1-6)
- `Known Affected Release(s)` â†’ version parsing
- `Known Fixed Releases` â†’ fixed version parsing
- `Last Modified` â†’ for incremental updates

**Logic**:
1. Parse CSV row by row
2. Detect version pattern (using VersionPatternDetector)
3. Check if bug has labels (from existing training data)
   - If labeled: Load with labels
   - If unlabeled: Mark as `labels_source='unlabeled'`, include anyway
4. Parse fixed versions
5. Insert into database with indexes
6. Update `db_metadata` with last processed date

**Label Checking**:
```python
# Check if bug exists in training_data_bugs_20251008_142230.csv
# If yes: Use those labels
# If no: Set labels=NULL, labels_source='unlabeled'
# Show warning: "X bugs unlabeled, run labeling script"
```

**Deliverables**:
- [ ] CSV parser with error handling
- [ ] Label checker against training data
- [ ] Version pattern detection integration
- [ ] Database insertion with rollback on error
- [ ] Progress tracking (X/Y bugs loaded)

---

### 1.3 Incremental Update System
**Owner**: VulnerabilityDBArchitectAgent
**Files**:
- `backend/db/incremental_update.py` - Update logic
- `get_last_update.py` - Helper script for user

**Workflow**:
```bash
# Initial load
python backend/db/load_bugs.py --input bugs/Cat9Kbugs_IOSXE_17.csv --initial
# Stores: db_metadata['last_bug_update'] = '2025-10-10'

# User checks last date
python get_last_update.py
# Output: "Last bug update: 2025-10-10"
#         "Download bugs with create_date > 2025-10-10"

# User downloads incremental CSV
# (manually from Cisco Bug Search with date filter)

# Incremental update
python backend/db/load_bugs.py --input bugs/Cat9Kbugs_IOSXE_17_incremental.csv --incremental
# - Skips duplicates (by bug_id)
# - Inserts only new bugs
# - Updates db_metadata timestamp
```

**Deliverables**:
- [ ] Duplicate detection logic
- [ ] Incremental insert (skip existing)
- [ ] Metadata timestamp update
- [ ] `get_last_update.py` CLI helper
- [ ] Documentation for incremental workflow

---

## Phase 2: Scanner Backend

### 2.1 Dual-Path Scanner
**Owner**: SystemArchitectAgent
**Files**:
- `backend/core/vulnerability_scanner.py` - Main scanner
- `backend/api/scan_routes.py` - New API endpoints

**Scanner Logic**:
```python
class VulnerabilityScanner:
    def scan_device(self, device_version, device_platform, device_labels):
        """
        Fast path: Query database for matching vulnerabilities

        Query:
        1. Match platform
        2. Match version (using version_index)
        3. Match at least 1 label (using label_index)
        4. Rank by severity (1-2 first)
        5. Return with match reasoning
        """

    def analyze_psirt(self, summary, platform, advisory_id=None):
        """
        Slow path: SEC-8B prediction (existing flow)

        Logic:
        1. Check if advisory_id in database â†’ return cached
        2. If not â†’ Run SEC-8B inference
        3. Optionally cache result in DB
        """
```

**New API Endpoints**:
```python
POST /api/v1/scan-device
{
  "device_version": "17.10.1",
  "device_platform": "IOS-XE",
  "device_labels": ["MGMT_SSH", "SEC_CoPP", "MGMT_SNMP"]
}

Response:
{
  "total_vulnerabilities": 15,
  "critical_high": [
    {
      "advisory_id": "CSCwo92456",
      "type": "BUG",
      "severity": 2,
      "summary": "...",
      "matched_labels": ["MGMT_SSH"],
      "version_match": "17.10.1 (exact)",
      "fixed_version": "17.10.3",
      "recommendation": "Upgrade to 17.10.3 or later"
    },
    ...
  ],
  "medium_low": [
    {advisory_id, type, severity, summary},
    ...  (collapsed, no details)
  ]
}
```

**Deliverables**:
- [ ] VulnerabilityScanner class
- [ ] Fast query with version + label matching
- [ ] Severity-based result grouping (1-2 full, 3-6 summary)
- [ ] Integration with existing SEC-8B flow
- [ ] API endpoint with request/response models

---

### 2.2 PSIRT Loader
**Owner**: VulnerabilityDBArchitectAgent
**Files**:
- `backend/db/load_psirts.py` - PSIRT CSV loader

**Input**: `output/enriched_gpt4o_with_labels.csv`
**Filter**: Platform = IOS-XE only (for Phase 1)

**Logic**: Similar to bug loader but:
- Parse `productNames` column for versions
- Extract CVE IDs from `cves` column
- Map severity from `sir` (High â†’ 2, Medium â†’ 3, etc.)
- All PSIRTs already have GPT-4o labels

**Deliverables**:
- [ ] PSIRT CSV parser
- [ ] Version extraction from productNames
- [ ] Database insertion with PSIRT-specific fields
- [ ] Deduplication check

---

## Phase 3: Frontend UI

### 3.1 Scan Mode UI
**Owner**: (Frontend specialist - you!)
**Files**:
- `frontend/src/components/ScanForm.tsx` - New scan form
- `frontend/src/components/ScanResults.tsx` - Results display
- `frontend/src/App.tsx` - Add "Scan Device" tab

**UI Design**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” Device Vulnerability Scanner        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Device Input:                           â”‚
â”‚ (*) Live Device (SSH)                   â”‚
â”‚ ( ) Feature Snapshot                    â”‚
â”‚                                         â”‚
â”‚ Platform: [IOS-XE â–¼]                    â”‚
â”‚ Version:  [17.10.1_____]                â”‚
â”‚                                         â”‚
â”‚ [Paste Snapshot or Enter SSH Creds]    â”‚
â”‚                                         â”‚
â”‚        [Start Scan]                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Results:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Š Found 15 Vulnerabilities             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âš ï¸ CRITICAL / HIGH (3)                  â”‚
â”‚                                         â”‚
â”‚ ğŸ”´ CSCwo92456 (Sev 2)                   â”‚
â”‚ Summary: SSH vulnerability allows...    â”‚
â”‚ Matched: MGMT_SSH                       â”‚
â”‚ Version: 17.10.1 (exact match)          â”‚
â”‚ Fix: Upgrade to 17.10.3                 â”‚
â”‚ [View Details] [Show Commands]          â”‚
â”‚                                         â”‚
â”‚ ğŸ”´ cisco-sa-snmp-dos (Sev 1)           â”‚
â”‚ Summary: SNMP DoS vulnerability...      â”‚
â”‚ Matched: MGMT_SNMP, SEC_CoPP            â”‚
â”‚ Version: 17.10.x (wildcard)             â”‚
â”‚ Fix: Upgrade to 17.12.1                 â”‚
â”‚ [View Details] [Show Commands]          â”‚
â”‚                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“‹ MEDIUM / LOW (12)                    â”‚
â”‚ â€¢ CSCabc12345 (Sev 3) - NAT issue       â”‚
â”‚ â€¢ CSCdef67890 (Sev 4) - BGP update      â”‚
â”‚ ... (collapsed list)                    â”‚
â”‚ [Expand All]                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Deliverables**:
- [ ] ScanForm component
- [ ] ScanResults component with severity grouping
- [ ] Expandable details for Sev 3-6
- [ ] Integration with scan API endpoint

---

## Phase 4: Integration & Testing

### 4.1 End-to-End Testing
**Owner**: (Test specialist - general-purpose agent)
**Files**:
- `tests/test_vuln_db.py` - Database tests
- `tests/test_scanner.py` - Scanner tests
- `tests/test_version_matching.py` - Version logic tests

**Test Cases**:
1. **Version Matching**:
   - Explicit: 17.10.1 matches only 17.10.1
   - Wildcard: 17.10.x matches 17.10.1, 17.10.5, not 17.11.1
   - Open Later: "17.10.3 and later" matches 17.10.5, not 17.10.2
   - Fixed Version: Device on 17.10.3, bug fixed in 17.10.3 â†’ NOT vulnerable

2. **Database Operations**:
   - Load 100 bugs â†’ verify all inserted
   - Incremental update â†’ verify no duplicates
   - Scan query performance (<100ms for 2,819 vulns)

3. **Scanner Integration**:
   - Scan IOS-XE 17.10.1 device â†’ expect X bugs
   - Compare with manual list â†’ validate results
   - Unknown PSIRT â†’ fallback to SEC-8B

**Deliverables**:
- [ ] Unit tests for all components
- [ ] Integration tests for full workflow
- [ ] Performance benchmarks
- [ ] Test data fixtures

---

## Phase 5: Documentation & Rollout

### 5.1 Documentation
**Owner**: (Documentation - general-purpose agent)
**Files**:
- `VULNERABILITY_DB_README.md` - User guide
- `docs/architecture_v2.md` - Architecture documentation
- `docs/version_matching.md` - Version logic reference

**Content**:
- How to load bug CSVs
- How to run incremental updates
- How to scan devices
- Version pattern examples
- Troubleshooting guide

**Deliverables**:
- [ ] User documentation
- [ ] Architecture diagrams
- [ ] API documentation
- [ ] Video walkthrough (optional)

---

## Task Assignment

| Component | Owner | Priority |
|-----------|-------|----------|
| Database Schema | VulnerabilityDBArchitectAgent | P0 |
| Version Pattern Logic | VulnerabilityDBArchitectAgent | P0 |
| Bug CSV Loader | VulnerabilityDBArchitectAgent | P0 |
| PSIRT CSV Loader | VulnerabilityDBArchitectAgent | P1 |
| Incremental Updates | VulnerabilityDBArchitectAgent | P1 |
| Scanner Backend | SystemArchitectAgent | P1 |
| Scan API Endpoints | SystemArchitectAgent | P1 |
| Frontend Scan UI | (You/Frontend) | P2 |
| Testing | general-purpose | P2 |
| Documentation | general-purpose | P3 |

## Success Criteria

**Phase 1 Complete**:
- [ ] Load Cat9Kbugs_IOSXE_17.csv into SQLite
- [ ] Query: "Find bugs affecting IOS-XE 17.10.1" â†’ Returns results <100ms
- [ ] Version matching works for all patterns
- [ ] Incremental update workflow documented

**Phase 2 Complete**:
- [ ] Scan API endpoint returns vulnerabilities
- [ ] Dual-path routing (DB vs LLM) works
- [ ] Results grouped by severity (1-2 full, 3-6 summary)

**Phase 3 Complete**:
- [ ] UI shows scan results
- [ ] User can scan live device or snapshot
- [ ] Results are actionable (fix versions, commands)

**MVP Ready**:
- [ ] Scan IOS-XE device â†’ Get all matching bugs + PSIRTs
- [ ] Performance: <100ms for DB scan, <3s with LLM fallback
- [ ] Air-gapped ready (no internet after initial load)
- [ ] Works alongside existing single-PSIRT mode

## Risk Mitigation

**Preservation of Existing Functionality**:
- âœ… New branch: `feature/vulnerability-database`
- âœ… Original code untouched on `feature/snapshot-verification`
- âœ… Can merge or abandon without breaking prod

**Rollback Plan**:
- If DB approach doesn't work, simply don't merge
- Existing UI and API remain functional
- Training data and FAISS index preserved

**Performance Risk**:
- If SQLite too slow: Add more indexes
- If version matching too complex: Fallback to exact match only
- If labeling bottleneck: Use existing labeled data only

## Timeline Estimate

- **Phase 1** (Database): 1-2 days
- **Phase 2** (Scanner): 1 day
- **Phase 3** (Frontend): 1 day
- **Phase 4** (Testing): 1 day
- **Phase 5** (Docs): 1 day

**Total**: ~5-7 days for full implementation

---

## Next Steps (Right Now)

1. **VulnerabilityDBArchitectAgent**: Start building database schema + loader
2. **SystemArchitectAgent**: Design scanner API contracts
3. **(Me)**: Monitor progress, review designs, provide domain knowledge

Let's execute Phase 1 first and validate the approach before building everything else!
